<h1>SOC Automation (Home Lab) - Part 1</h1>

<p align="center">
<img src="https://snipboard.io/6rb2ue.jpg" height="80%" width="80%" alt="Disk Sanitization Steps"/>
<h2>Description</h2>
<br />
<p align="center">
Welcome to the final part of the series of the active directory project. If you haven't seen the previous parts where we go over how to build out a diagram for this lab, install our virtual machines, configure our tools, and apptive directory, I highly recommend you watch those first to get up to speed.
  
Today's objective is to use Kali Linux to perform a brute-force attack onto our users, giving you a chance to see what this looks like by using Splunk to query for this activity. Afterwards, we will set up and install Atomic Red Team and run a test together. So in the future, you know how to use Atomic Red Team to generate telemetry and detect similar attacks in the future. Also, if you have a machine that does not have at least 16 gigs of RAM. Now, will be a good time to change both the DCs' and target machines ram to 2 gigs, instead of four. Let's get started.

On our Kali Linux machine, the Kali default credentials are "Kali" and "Kali" for the password. We want to set up a static IP address of '192.168.10.250' as per our diagram. To do this, we can right-click the ethernet icon at the top and select "Edit connections".

We want to select the first profile which in my case is called "Wired connection 1". At the bottom left, select the gear icon and then select "ipv4 settings". Under the drop-down, it is currently set to "Automatic (DHCP)". 

You want to click on that and select "Manual". Click on "Add". For the IP address, we'll type in '192.168.10.250". The "Netmask" will be '24' and the "Gateway" is '192.168.10.1'. For the DNS server, it will be '8.8.8.8'. Then, we'll hit "Save". I'll close this out.

Right-click and click on "Open Terminal Here". Now, type in IP space a and you might notice that our IP did not change yet if you take a look over here it is 192.168.10.0 and to reflect these changes we can simply click on the ethernet icon and click disconnect this will disconnect our network interface and then we can click on it again and select our profile of wired connection one clear out the screen and now let's type in IP space a again and we do get our IP address of 192.1681 250 and just like anything else let's verify our connectivity by pinging google.com and we have connectivity now let's try pinging our Splunk server which is 1921 168 1010 and we get connectivity now let's update and upgrade our repositories by typing in pseudo AP get update and pseudo apt get upgrade with a-y type in Cali for the password and depending on your download speeds this might take some time once the update and upgrade is finished we can start setting up our attack by first creating a new directory called a ad- project and to do that we'll type in mkd and I'll type in ad- project this will create a directory on our desktop and all of the files that we will create and use will be put into this directory for our attack today I'll be using a tool called crowbar and we can install this by typing in pseudo get install Dy crowbar type in the password and it should go out and install our tool so this is the tool that we will use to perform Brute Force attacks and we can Target either our domain controller or our Target machine and I have to say this please do not Target any assets that you do not have permission to do so only use this for educational purposes and use this for your Labs on machines that you own now that we have this tool installed we want to use a popular word list called rocku that comes with Cali Linux this is found under the directory user SL share slw list and if I type in LS we can see that there is a file called Rock you. text. gz we can unzip this file using gunzip so let's type in pseudo gunzip rocku and type in LS again and now we should see rocky. text let's copy this file onto our ad project folder by typing in cpu. text squiggly line back slash desktop back SL ad- project and I'll hit tab for autoc completion hit enter and now let's change in to our ad project directory I'll type in clear to clear out the screen and ls- LH we see the file size of rocky. text which is about 134 Megs so this contains quite a bit of password and we don't want to use all of it for the sake of this demo so instead we'll use the first 20 lines and to do that I'll use the command head- N20 to specify I only want 20 lines point it to rock you. text and if I hit enter I'll see 20 lines I'll clear this out and I'll output it to a file called password. text and we can do this by putting in a greater than sign right here and I'll list out passwords text hit enter type in LS and we should see a password. text we can open this up by typing in cat type in our our password text and hit enter and we do see our 20 lines now as an attacker you would probably do a lot of Recon probably set up some basic active directory attacks but let's just say in our scenario we know we want to Target a certain password so that's what I'll do I'll type in nanop password. text to edit it and at the very bottom I'll type in the super secure password and I'll save it out by holding contrl X Type in y enter now if we cat out password. text again we should see our super secure password at the bottom now before we launch the attack let's head over to our Windows Target machine on our Windows Target Enable RDP machine we want to enable remote desktop and to do that we want to search up for PC so we'll go ahead and type in PC and we'll click on properties once we open that up we can scroll down and click on Advanced system settings and we'll log in with the administrator account once we have this open opened we want to click on the remote Tab and then at the bottom you want to select allow remote connections to this computer and we'll select users click on ADD and we'll put in our two users so one is Jenny Smith I'll click on check names and the second is Terry Smith so T Smith check names again and once those are good to go we can click on Okay click on okay hit apply click okay to close out so now we have enabled remote desktop onto our Target machine if you want you can enable remote desktop on your active directory server but we're going to just skip on that for now and just only focus on our Target machine Let's head back over to our Cali Linux machine I'll go Brute force tool usage ahead and clear the screen and to use our tool we'll just type in crowbar with a dashh flag this way we can see the help menu and see what kind of options are available for for us if we scroll all the way to the top we can see that the description crowbar is a Brute Force tool which supports openvpn remote desktop protocol SSH private keys and VNC Keys the service that we're interested here is remote desktop protocol this is why we're using this tool and why we enabled RDP the command that I'll use with crowbar is the following I'll use the dasb flag to specify my service and in my case it is RDP P which is remote desktop protocol - lowercase U and then I'll specify the account of interest for this example let's just say we are targeting Terry Smith so that is T Smith and then Das Capital C to specify a password list we did create one earlier and that was called password. text lastly I'll type in- lowercase s to specify my source IP and the target machines I IP was 192.168.10.10 and we must specify a CER notation I will use the sl32 cider notation instead of sl24 this is because I only want to Target this one IP again this goes back to networking and if you aren't sure what I'm talking about do take some time to learn more about networking fundamentals I'll hit enter to run the command once we execute crowbar it will start trying out all the passwords that are listed under the passwords dotex file and eventually as we can see we have an RDP success with the username of T Smith and the password right here pretty cool so let's now head over to Splunk and see what Telemetry we had generated now that we're in Splunk
Splunk we'll select search and Reporting and because we did generate the attack we know that this occurred within the past 15 minutes and we also know that the targeted user was T Smith Smith so let's narrow down our search and only look for events related to T Smith so I'll type in index equals end point and then I'll click on the time and I'll say last 15 minutes and I'll also add in T Smith and hit enter so right away we have 23 events and if we scroll down just a little bit we have a field name called event code now if we click on that we see a total of 20 counts for the event event ID of 4625 now if we were to search what that means so we can type in event ID 4625 we can click into ultimate Windows security and it says here an account failed to log on so this means that there was 20 failed attempts to log into T Smith's account which is correct if you recall our password. text file there was a total of 21 passwords one of them being the correct one now if I were to just select 4625 it would automatically update our query and search for it as you can see with the 20 events here and if we scroll down I want you to take a look at the time so it says 13533 and you might notice that all of these events are happening pretty much at the same time which can be a clear indication of Brute Force activity now if we take a look at event code 4624 we have one event and if you're not sure what 4624 is we can head back over to the ultimate Windows security and then we'll type in 4624 and it says an account was successfully logged on head back over to our Splunk we can expand this event by clicking on show all 70 lines and if we were to scroll down just a bit we do happen to see our workstation name as Cali as well as its IP address that it's trying to log in from and this does indeed belong to our Cali Linux machine next let's install Atomic red team on our Target machine and then we can run some test on it to do that we'll have to open up Powershell with administrator
Installing ART privileges so we'll search for Powershell and run as administrator we'll log in using the administrator account and then we'll run the following command set- execution policy bypass current user and then hit enter we want to type in y and then hit enter next we'll install the atomic red team framework but before we actually do that let's set an exclusion for the entire C drive as Microsoft Defender will detect and remove some of the files from Atomic red team so to do that we'll click on the up arrow and click on Windows security and click on virus and threat protection manage settings scroll down under exclusion we want to add or remove exclusion click on add an exclusion and then select folder simply select this PC scroll down and select our C drive and then click on select folder we'll have to log in again as administrator and we should see an exclusion for the C drive now we can start installing Atomic red team to install Atomic red team you want to run the following command and I'll put this in the description down below this will go out and grab Atomic red team and install it onto your target machine when you see this you want to press Y and hit enter to install the dependencies and once a Atomic red team is completed head over to the C drive and then click under the directory Atomic red team here we will see what are called atomics if we go into that we see a bunch of technique IDs and these map back to miter attack framework so if we head over to the miter attack framework if we scroll down to the Matrix for Enterprise and if we highlight any of them we notice that hey there is a technique ID of t119 so if that is something something we wanted to test we can take a look and see if there's any t119 and there doesn't appear to be any so that's okay we can try and test out maybe a persistence tactic perhaps a create account so t136 we can take a look and see if there's any t136 and we do happen to see three of them here so there's 1 2 and three if we go and look at our miter attack framework we see that one is local account two is domain account and three is cloud account and looking at our atomics we have all three options in this example let's go ahead and use the first one which is the local account so I'll go ahead and clear the screen here and to use the command we type in invoke Das Atomic test and then we'll type in the technique ID which was t11 36. 001 and then I'll hit enter so this will automatically generate Telemetry based on creating a local account I want you to take a look at the username that was created which is new local user and now that our Command has finished running we can go and look into Splunk and search specifically for new local user we'll type in index equals endpoint and it was new local user and look at that we don't get any events that's kind of odd isn't it but but in a way that's actually a good thing cuz this now tells you that you're blind to this activity if an attacker compromised your system and created a local account with your current settings you will not be able to detect that activity this is why I love atomic red team it will identify the gaps and visibility for you it will also generate the Telemetry to see if you can actually detect that activity let's do another example here we'll go into miter attack and this time I will select the command and scripting interpreter so this one is t159 do we have any t159 and we do have a couple of them we have one all the way up until seven so I think that's all of the sub techniques there we can expand that let's see 1 2 3 4 five 6 7even so there's Powershell which I know for sure we should be able to see so why don't we do that we'll execute that technique so I'll clear it the screen press the up Arrow key and then it was t159 was it let me double check yeah T10 59.1 and then hit enter so Defender is catching some threats we see a Powershell command here exact bypass no profile perhaps that is something we can search for in Splunk let's go ahead and open up Splunk and take a look I'll change the last time to 15 minutes and actually look at that we do see a new local user Okay cool so it just took some time but the concept still applies so we can detect that activity however if you happen to see no events even after waiting for a bit then that means you have a gap in visibility now if we were to look at Powershell scrolling down we do see an event over here it is quite hard to see but I'll zoom in we see exact bypass no profile XML and if you recall in our Powershell window that is this Command right here so this means that hey we can build alerts to detect on this activity in the future if we wanted to along with creating a new local user account now that we know that the event actually generates it just takes a little time before we end there is one last thing I wanted to talk about and that is with Cali Linux in my example I used T Smith with the password of this password now if you created a different account with a different password and you want to follow along along you need to make sure that your password is listed in the passwords doxt file CU as you can see at the bottom my password is right there so if your password to T Smith or to another user account was let's just say summer 20124 with an exclamation mark then you need to make sure you put that into your passwords do text file otherwise this tool wouldn't be able to Brute Force successfully so that's just one quick note and if you're new to Virtual box and you don't know what a snapshot is it's essentially it's essentially a backup so if I did happen to break something and my Cali Linux no longer works for example I can revert it back to a snapshot to a known good State and to take a snapshot you simply click on machine at the top and select take snapshot and then you want to put in a name if you wanted to also with a description and hit okay now to revert to a snapshot there are a lot of different options but you can simply click on close and then just check restore current snapshot and that's it if you have followed along you have successfully completed the active directory project and I hope that you had as much fun as I did creating this we went over a ton of material and I know it can get pretty technical very quickly I would encourage you to take a look at my video about miter attack and atomic red team if you got lost during that section I cannot stress this enough if you want to become an amazing blue teamer you must understand how miter attack works as this will provide you with some guidance on what an attacker might do once they compromise in environment the S course that I'm currently building will cover this and will also include a lot of labs that will allow you to query and find evil using miter attack I am not lying when I say this I am going to trans transform you if you are an aspiring blue teamer specifically within the security operations domain you will love this course I'll leave a link down below for you to sign up if you're interested it will be a paid course and I'll provide an update on pricing hopefully sometime in April when I begin to finalize all of the content it would mean a lot to me if you shared this project with other aspiring analysts who want to get some hands-on experience and seriously thank you so much for watching and I truly hope that this has helped you in any way remember to stay curious and do things
20:41
differently
